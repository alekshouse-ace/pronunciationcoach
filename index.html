<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pronunciation Coach AI + Diary</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f3f4f6; 
            touch-action: manipulation;
        }
        .btn-press:active { transform: scale(0.95); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root" class="flex items-center justify-center min-h-screen text-gray-500">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500 mb-4"></i>
            <p>Loading AI Coach & Diary...</p>
        </div>
    </div>

    <!-- Firebase Configuration & Exposure -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Expose to window for React
        window.Firebase = {
            auth, db, appId,
            signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            collection, addDoc, onSnapshot, query
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const initialData = {
            "Voiced 'Th'": [
                { text: "This", context: "Tongue between teeth." },
                { text: "That", context: "Not 'Dat'." },
                { text: "These", context: "Long E + Th." },
                { text: "Those", context: "Round lips." },
                { text: "This is the app", context: "Classroom phrase." }
            ],
            "Long 'O'": [
                { text: "Phone", context: "Pho-u-ne." },
                { text: "Mode", context: "Live mode." },
                { text: "Code", context: "Class code." },
                { text: "Download", context: "Down-low-d." }
            ],
            "Word Endings": [
                { text: "Guide", context: "Strong 'D'." },
                { text: "Page", context: "Soft 'J'." },
                { text: "Job", context: "Strong 'B'." },
                { text: "Send", context: "Not 'Sen'." }
            ],
            "Connectors": [
                { text: "Next", context: "Instead of 'So'." },
                { text: "However", context: "Contrast." },
                { text: "Notice that", context: "Attention." }
            ],
             "S vs Sh": [
                { text: "Specific", context: "Sss-pecific." },
                { text: "Show", context: "Shh-ow." },
                { text: "Simple", context: "Sss-imple." }
            ]
        };

        const App = () => {
            // View States
            const [view, setView] = useState("practice"); 
            const [userApiKey, setUserApiKey] = useState("");
            const [hasKey, setHasKey] = useState(false);
            
            // App States
            const [selectedCategory, setSelectedCategory] = useState("Voiced 'Th'");
            const [items, setItems] = useState(initialData);
            const [feedback, setFeedback] = useState({});
            const [isRecording, setIsRecording] = useState(false);
            const [audioURLs, setAudioURLs] = useState({});
            
            // AI States
            const [isGenerating, setIsGenerating] = useState(false);
            const [isGeneratingTwister, setIsGeneratingTwister] = useState(false);
            const [isGeneratingPairs, setIsGeneratingPairs] = useState(false);
            const [isGeneratingRoleplay, setIsGeneratingRoleplay] = useState(false);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysisResult, setAnalysisResult] = useState({});
            const [ruleExplanation, setRuleExplanation] = useState("");
            const [isExplaining, setIsExplaining] = useState(false);

            // Firebase User & Data
            const [user, setUser] = useState(null);
            const [diaryEntries, setDiaryEntries] = useState([]);

            const mediaRecorderRef = useRef(null);
            const chunksRef = useRef([]);
            const recognitionRef = useRef(null);

            // --- 1. KEY MANAGEMENT ---
            useEffect(() => {
                // Check if key is already saved in browser
                const storedKey = localStorage.getItem("gemini_api_key");
                if (storedKey) {
                    setUserApiKey(storedKey);
                    setHasKey(true);
                }
            }, []);

            const saveKey = () => {
                if (userApiKey.trim().startsWith("AIza")) {
                    localStorage.setItem("gemini_api_key", userApiKey.trim());
                    setHasKey(true);
                } else {
                    alert("Invalid Key. It should start with 'AIza'");
                }
            };

            const clearKey = () => {
                localStorage.removeItem("gemini_api_key");
                setHasKey(false);
                setUserApiKey("");
            };

            // --- 2. FIREBASE INIT ---
            useEffect(() => {
                if (!window.Firebase) return;
                const { auth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.Firebase;

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Auth Error", e);
                    }
                };

                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
                return () => unsubscribe();
            }, []);

            // --- 3. FETCH DIARY ---
            useEffect(() => {
                if (!user || !window.Firebase) return;
                const { db, appId, collection, onSnapshot } = window.Firebase;

                const q = collection(db, 'artifacts', appId, 'users', user.uid, 'diary');
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (!snapshot || !snapshot.docs) return;
                    const loaded = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    loaded.sort((a, b) => b.timestamp - a.timestamp);
                    setDiaryEntries(loaded);
                }, (err) => console.error("Diary fetch error", err));

                return () => unsubscribe();
            }, [user]);

            // --- 4. HELPER: SAVE TO DIARY ---
            const saveToDiary = async (entry) => {
                if (!user || !window.Firebase) return;
                const { db, appId, collection, addDoc } = window.Firebase;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'diary'), {
                        ...entry,
                        timestamp: Date.now()
                    });
                } catch (e) {
                    console.error("Save error", e);
                }
            };

            // --- 5. AI LOGIC (Unified) ---
            const safeGeminiCall = async (prompt, isJson = false) => {
                if (!userApiKey) {
                    alert("API Key missing. Please restart app and enter key.");
                    return null;
                }
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: isJson ? { responseMimeType: "application/json" } : undefined
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 400) {
                            alert("Invalid API Key. Please click the 'Reset Key' button at the top.");
                            return null;
                        }
                        throw new Error("API Response not OK");
                    }
                    
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!text) throw new Error("No text generated");
                    
                    return isJson ? JSON.parse(text) : text;
                } catch (e) {
                    console.error("Gemini Error:", e);
                    return null;
                }
            };

            // AI Action Wrappers
            useEffect(() => { setRuleExplanation(""); }, [selectedCategory]);

            const explainRule = async () => {
                if (isExplaining) return;
                setIsExplaining(true);
                const text = await safeGeminiCall(`Act as an expert speech therapist. Briefly explain the physical articulation for: "${selectedCategory}". Describe tongue position, lip shape, airflow. Under 60 words.`, false);
                if (text) setRuleExplanation(text);
                setIsExplaining(false);
            };

            const generateNewSentences = async () => {
                if (isGenerating) return;
                setIsGenerating(true);
                const data = await safeGeminiCall(`Generate 3 short British English sentences for: "${selectedCategory}". JSON array with "text" and "context" (2-4 word tip).`, true);
                if (data) setItems(prev => ({ ...prev, [selectedCategory]: [...(prev[selectedCategory] || []), ...data] }));
                setIsGenerating(false);
            };

            const generateTongueTwister = async () => {
                if (isGeneratingTwister) return;
                setIsGeneratingTwister(true);
                const data = await safeGeminiCall(`Generate 1 difficult British English tongue twister for "${selectedCategory}". JSON array with "text" and "context" ("Tongue Twister!").`, true);
                if (data) setItems(prev => ({ ...prev, [selectedCategory]: [...(prev[selectedCategory] || []), ...data] }));
                setIsGeneratingTwister(false);
            };

            const generateMinimalPairs = async () => {
                if (isGeneratingPairs) return;
                setIsGeneratingPairs(true);
                const data = await safeGeminiCall(`Generate 3 minimal pairs for "${selectedCategory}" vs a common error. JSON array with "text" ("Word1 vs Word2") and "context" (contrast explanation).`, true);
                if (data) setItems(prev => ({ ...prev, [selectedCategory]: [...(prev[selectedCategory] || []), ...data] }));
                setIsGeneratingPairs(false);
            };

            const generateRoleplay = async () => {
                if (isGeneratingRoleplay) return;
                setIsGeneratingRoleplay(true);
                const data = await safeGeminiCall(`Generate 1 short dialogue (2 lines, A & B) heavy on "${selectedCategory}". JSON array with "text" (full script) and "context" ("Roleplay").`, true);
                if (data) setItems(prev => ({ ...prev, [selectedCategory]: [...(prev[selectedCategory] || []), ...data] }));
                setIsGeneratingRoleplay(false);
            };

            const analyzePronunciationError = async (targetWord, heardWord, index) => {
                setIsAnalyzing(index);
                const text = await safeGeminiCall(`I said "${heardWord}" instead of "${targetWord}". 1. Explain physical mistake. 2. Give physical tip. concise.`, false);
                if (text) setAnalysisResult(prev => ({ ...prev, [index]: text }));
                setIsAnalyzing(false);
            };

            // --- 6. RECORDING ---
            const speak = (text) => {
                if (!window.speechSynthesis) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-GB';
                utterance.rate = 0.85;
                window.speechSynthesis.speak(utterance);
            };

            const stopEverything = () => {
                if (recognitionRef.current) try { recognitionRef.current.stop(); } catch(e) {}
                if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
                    mediaRecorderRef.current.stop();
                }
                setIsRecording(false);
            };

            const handleRecord = async (targetText, index) => {
                setAnalysisResult(prev => { const n = {...prev}; delete n[index]; return n; });
                if (isRecording === index) { stopEverything(); return; }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    setFeedback(prev => ({ ...prev, [index]: { status: 'error', message: 'Use Chrome browser.' } }));
                    return;
                }

                setIsRecording(index);
                setFeedback(prev => ({ ...prev, [index]: { status: 'listening', message: 'Listening...' } }));
                setAudioURLs(prev => ({ ...prev, [index]: null }));

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorderRef.current = new MediaRecorder(stream);
                    chunksRef.current = [];
                    mediaRecorderRef.current.ondataavailable = e => { if (e.data.size > 0) chunksRef.current.push(e.data); };
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
                        const url = URL.createObjectURL(blob);
                        setAudioURLs(prev => ({ ...prev, [index]: url }));
                        stream.getTracks().forEach(track => track.stop());
                    };
                    mediaRecorderRef.current.start();

                    const recognition = new SpeechRecognition();
                    recognitionRef.current = recognition;
                    recognition.lang = 'en-GB';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    recognition.onresult = (event) => {
                        if (!event.results?.[0]) return;
                        const transcript = event.results[0][0].transcript;
                        const cleanTrans = transcript.toLowerCase().replace(/[^\w\s]/gi, '');
                        const cleanTarget = targetText.toLowerCase().replace(/[^\w\s]/gi, '');
                        const isSuccess = cleanTrans.includes(cleanTarget) || cleanTarget.includes(cleanTrans) || (cleanTarget.length > 20 && transcript.length > 5);
                        
                        if (isSuccess) {
                            setFeedback(prev => ({ ...prev, [index]: { status: 'success', message: `Heard: "${transcript}"` } }));
                        } else {
                            setFeedback(prev => ({ ...prev, [index]: { status: 'error', message: `Heard: "${transcript}"`, transcript: transcript } }));
                        }
                        saveToDiary({ category: selectedCategory, target: targetText, heard: transcript, success: isSuccess });
                    };

                    recognition.onerror = (event) => {
                        let msg = "Try again.";
                        if (event.error === 'no-speech') msg = "No speech detected.";
                        if (event.error === 'not-allowed') msg = (window.self !== window.top) ? "Blocked by Embed." : "Mic blocked.";
                        setFeedback(prev => ({ ...prev, [index]: { status: 'error', message: msg } }));
                        stopEverything();
                    };

                    recognition.onend = () => { if (isRecording === index) stopEverything(); };
                    recognition.start();
                } catch (err) {
                    setFeedback(prev => ({ ...prev, [index]: { status: 'error', message: 'Mic access denied.' } }));
                    setIsRecording(false);
                }
            };

            const playUserAudio = (index) => { if (audioURLs[index]) new Audio(audioURLs[index]).play(); };

            // --- RENDER VIEWS ---
            
            // 1. LOGIN SCREEN
            if (!hasKey) {
                return (
                    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full">
                            <div className="text-center mb-6">
                                <i className="fas fa-key text-4xl text-indigo-500 mb-2"></i>
                                <h1 className="text-2xl font-bold text-gray-800">Setup AI Coach</h1>
                                <p className="text-sm text-gray-500 mt-2">Enter your Google Gemini API Key to enable AI features.</p>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-1">API Key</label>
                                    <input 
                                        type="password" 
                                        value={userApiKey}
                                        onChange={(e) => setUserApiKey(e.target.value)}
                                        placeholder="Paste AIza... key here"
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">This is saved securely in your browser.</p>
                                </div>
                                <button 
                                    onClick={saveKey}
                                    className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 transition-colors shadow-lg"
                                >
                                    Start Learning
                                </button>
                                <div className="text-center mt-4">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-indigo-500 hover:underline">
                                        Get a free key here <i className="fas fa-external-link-alt ml-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 2. DIARY VIEW
            const DiaryView = () => {
                const grouped = {};
                diaryEntries.forEach(entry => {
                    const d = new Date(entry.timestamp).toLocaleDateString();
                    if (!grouped[d]) grouped[d] = [];
                    grouped[d].push(entry);
                });

                return (
                    <div className="p-4 pb-20 space-y-6">
                        {Object.keys(grouped).length === 0 ? (
                            <div className="text-center py-10 bg-white rounded-xl shadow-sm">
                                <i className="fas fa-book-open text-4xl text-gray-300 mb-3"></i>
                                <p className="text-gray-500">No practice history yet.</p>
                                <button onClick={() => setView('practice')} className="mt-3 text-indigo-600 font-bold hover:underline">Start Practicing!</button>
                            </div>
                        ) : (
                            Object.keys(grouped).map(dateStr => {
                                const dayEntries = grouped[dateStr];
                                const correct = dayEntries.filter(e => e.success).length;
                                const accuracy = Math.round((correct / dayEntries.length) * 100);
                                return (
                                    <div key={dateStr} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden animate-fade-in">
                                        <div className="bg-gray-50 p-3 border-b flex justify-between items-center">
                                            <h3 className="font-bold text-gray-700">{dateStr}</h3>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-xs text-gray-500">{dayEntries.length} Attempts</span>
                                                <span className={`text-xs font-bold px-2 py-0.5 rounded-full ${accuracy > 70 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>{accuracy}% Accuracy</span>
                                            </div>
                                        </div>
                                        <div className="divide-y divide-gray-100">
                                            {dayEntries.map((entry, i) => (
                                                <div key={i} className="p-3 flex items-center justify-between hover:bg-gray-50">
                                                    <div>
                                                        <div className="font-medium text-gray-800 break-words max-w-[200px] text-sm">{entry.target}</div>
                                                        <div className="text-xs text-gray-400">{entry.category}</div>
                                                    </div>
                                                    <div className="flex items-center">
                                                        {entry.success ? <span className="text-green-500"><i className="fas fa-check-circle"></i></span> : <div className="text-right"><span className="text-red-400 block"><i className="fas fa-times-circle"></i></span></div>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>
                );
            };

            const currentItems = items[selectedCategory] || [];

            // 3. MAIN APP VIEW
            return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-xl md:max-w-2xl border-x border-gray-200 flex flex-col">
                    {/* Header */}
                    <div className="bg-indigo-600 p-5 text-white shadow-md z-20">
                        <div className="flex justify-between items-center mb-3">
                            <div>
                                <h1 className="text-2xl font-bold">Pronunciation AI</h1>
                                <p className="text-indigo-200 text-xs">Teacher Fluency Coach</p>
                            </div>
                            <button onClick={clearKey} className="text-xs bg-indigo-800 px-2 py-1 rounded text-indigo-300 hover:text-white">Reset Key</button>
                        </div>
                        <div className="flex bg-indigo-700 rounded-lg p-1">
                            <button onClick={() => setView("practice")} className={`flex-1 px-3 py-1 rounded-md text-sm font-medium transition-all ${view === "practice" ? "bg-white text-indigo-700 shadow" : "text-indigo-200 hover:text-white"}`}>Practice</button>
                            <button onClick={() => setView("diary")} className={`flex-1 px-3 py-1 rounded-md text-sm font-medium transition-all ${view === "diary" ? "bg-white text-indigo-700 shadow" : "text-indigo-200 hover:text-white"}`}>Diary</button>
                        </div>
                    </div>

                    {view === "practice" ? (
                        <>
                            {/* Nav */}
                            <div className="flex overflow-x-auto p-3 bg-gray-50 border-b scrollbar-hide space-x-2 sticky top-0 z-10">
                                {Object.keys(items).map(cat => (
                                    <button key={cat} onClick={() => { setSelectedCategory(cat); setFeedback({}); setAudioURLs({}); setAnalysisResult({}); stopEverything(); }} className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all ${selectedCategory === cat ? 'bg-indigo-600 text-white shadow-lg transform scale-105' : 'bg-white text-gray-600 border border-gray-200'}`}>{cat}</button>
                                ))}
                            </div>

                            {/* Content */}
                            <div className="flex-1 p-4 pb-20 space-y-4 bg-gray-50 overflow-y-auto">
                                <div className="bg-blue-50 rounded-xl p-4 border border-blue-100 shadow-sm">
                                    <div className="flex justify-between items-center mb-2">
                                        <h3 className="font-bold text-blue-800"><i className="fas fa-info-circle mr-2"></i>How to pronounce:</h3>
                                        <button onClick={explainRule} disabled={isExplaining} className="text-xs bg-white text-blue-600 px-3 py-1 rounded-full border border-blue-200 hover:bg-blue-50 font-bold">{isExplaining ? <i className="fas fa-spinner fa-spin"></i> : <><i className="fas fa-magic mr-1"></i> Explain Rule</>}</button>
                                    </div>
                                    {ruleExplanation ? <p className="text-sm text-blue-900 leading-relaxed animate-fade-in">{ruleExplanation}</p> : <p className="text-xs text-blue-400 italic">Click "Explain Rule" for a speech therapy tip.</p>}
                                </div>

                                {currentItems.map((item, index) => (
                                    <div key={index} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 transition-all hover:shadow-md">
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1 mr-2">
                                                <h3 className="text-xl font-bold text-gray-800 leading-tight whitespace-pre-wrap">{item.text}</h3>
                                                <p className="text-xs text-gray-500 mt-1 uppercase tracking-wide font-bold text-indigo-400">{item.context}</p>
                                            </div>
                                            <button onClick={() => speak(item.text)} className="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 btn-press flex-shrink-0"><i className="fas fa-volume-high text-lg"></i></button>
                                        </div>
                                        <div className="mt-4 flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                                            <div className="flex items-center space-x-3">
                                                <button onClick={() => handleRecord(item.text, index)} className={`w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-sm ${isRecording === index ? 'bg-red-500 text-white animate-pulse ring-4 ring-red-100' : 'bg-white border text-indigo-600 hover:border-indigo-400'}`}><i className={`fas ${isRecording === index ? 'fa-stop' : 'fa-microphone'}`}></i></button>
                                                {audioURLs[index] && !isRecording && <button onClick={() => playUserAudio(index)} className="px-3 py-1 text-xs font-bold text-gray-700 bg-gray-200 rounded hover:bg-gray-300">â–¶ Play Mine</button>}
                                            </div>
                                            <div className="flex-1 ml-3 text-right">
                                                {feedback[index] ? <div className={`text-sm font-bold animate-fade-in ${feedback[index].status === 'success' ? 'text-green-600' : 'text-red-500'}`}>{feedback[index].status === 'success' ? <i className="fas fa-check mr-1"></i> : <i className="fas fa-times mr-1"></i>}{feedback[index].message}</div> : <span className="text-xs text-gray-400">Tap mic to start</span>}
                                            </div>
                                        </div>
                                        {feedback[index]?.status === 'error' && feedback[index]?.transcript && (
                                            <div className="mt-3 border-t pt-2 animate-fade-in">
                                                {!analysisResult[index] ? <button onClick={() => analyzePronunciationError(item.text, feedback[index].transcript, index)} disabled={isAnalyzing === index} className="w-full py-2 bg-gradient-to-r from-purple-100 to-indigo-100 text-indigo-700 text-sm font-bold rounded-lg flex items-center justify-center gap-2 hover:opacity-90">{isAnalyzing === index ? <><i className="fas fa-circle-notch fa-spin"></i> Analyzing...</> : <><i className="fas fa-magic"></i> Why did I fail?</>}</button> : <div className="bg-purple-50 p-3 rounded-lg text-sm text-purple-900 border border-purple-100"><div className="font-bold flex items-center gap-2 mb-1"><i className="fas fa-graduation-cap"></i> Coach Tip:</div><div className="leading-relaxed">{analysisResult[index]}</div></div>}
                                            </div>
                                        )}
                                    </div>
                                ))}

                                <div className="pt-4 pb-10">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">AI Tools</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={generateNewSentences} disabled={isGenerating} className="py-3 bg-white text-indigo-600 border border-indigo-200 rounded-xl font-bold shadow-sm hover:bg-indigo-50 transform transition-all active:scale-95 flex flex-col items-center justify-center gap-1 disabled:opacity-70">{isGenerating ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-plus-circle text-xl"></i>}<span className="text-xs">More Sentences</span></button>
                                        <button onClick={generateTongueTwister} disabled={isGeneratingTwister} className="py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold shadow-md hover:shadow-lg transform transition-all active:scale-95 flex flex-col items-center justify-center gap-1 disabled:opacity-70">{isGeneratingTwister ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-fire text-xl text-yellow-300"></i>}<span className="text-xs">Challenge Me!</span></button>
                                        <button onClick={generateMinimalPairs} disabled={isGeneratingPairs} className="py-3 bg-white text-green-600 border border-green-200 rounded-xl font-bold shadow-sm hover:bg-green-50 transform transition-all active:scale-95 flex flex-col items-center justify-center gap-1 disabled:opacity-70">{isGeneratingPairs ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-balance-scale text-xl"></i>}<span className="text-xs">Minimal Pairs</span></button>
                                        <button onClick={generateRoleplay} disabled={isGeneratingRoleplay} className="py-3 bg-white text-pink-600 border border-pink-200 rounded-xl font-bold shadow-sm hover:bg-pink-50 transform transition-all active:scale-95 flex flex-col items-center justify-center gap-1 disabled:opacity-70">{isGeneratingRoleplay ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-theater-masks text-xl"></i>}<span className="text-xs">Roleplay Script</span></button>
                                    </div>
                                </div>
                            </div>
                        </>
                    ) : <DiaryView />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
